<!doctype html>
{% extends 'layout.html' %}


{# Title #}
{% block title %}
  Revenue Dashboard - EduTecX
{% endblock %}


{# Body #}
{% block mainContent %}
  <div id="graph-container" class="mx-auto my-2 ratio-16x9 w-50 h-50">
    <img id="graph" src="" alt="Drawing..." width="100%" height="100%" />
  </div>


  <script>
    // Update graph URI
    const fetchGraphURI = async () => {
      response = await fetch('/dashboard/graph', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': getAccessToken()
        },
        body: JSON.stringify({
          "graphFor": "Revenue"
        })
      })

      data = await response.json()
      if (!response.ok) throw new Error(data.message)

      $('#graph').attr('src', data.data.uri)
      console.log('Fetched URI: ' + data.data.uri)
    }

    // Stream fetched
    const fetchUserData = async () => {
      let searchParams = ((new URL(location.href)).searchParams)
      let criteria = searchParams.get('criteria')
      criteria = ['or', 'and'].includes(criteria) ? criteria : 'or'

      searchParams.set('requestFor', 'Sale')
      searchParams.set('criteria', criteria)

      response = await fetch(`/dashboard/get?${searchParams.toString()}`, {
        method: 'GET',
        headers: {
          'X-CSRF-TOKEN': getAccessToken()
        }
      })

      data = await response.json()
      if (!response.ok) throw new Error(data.message)

      /* TODO: Inject data at runtime */
      console.log('Fetched Data')
    }


    // Run in parallel
    $(document).ready(() => Promise.all([ fetchGraphURI(), fetchUserData() ])
      .then(values => console.log(values))
      .catch(err => console.log(err)))
  </script>
{% endblock %}
